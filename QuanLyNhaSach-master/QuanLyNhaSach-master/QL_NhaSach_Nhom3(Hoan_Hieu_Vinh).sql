CREATE DATABASE QLNHASACH
ON PRIMARY
(
	NAME = 'NHOM3QLNHASACH_PRIMARY',
	FILENAME ='C:\baocao\QL_NHASACH_NHOM3(HOAN_HIEU_VINH).mdf',
	SIZE =5MB,
	MAXSIZE =5MB,
	FILEGROWTH =10%
)
LOG ON
(
	NAME = 'NHOM3QLNHASACH_LOG',
	FILENAME ='C:\baocao\QL_NHASACH_NHOM3(HOAN_HIEU_VINH).ldf',
	SIZE =5MB,
	MAXSIZE =10MB,
	FILEGROWTH =10%
)
GO
USE QLNHASACH
GO

CREATE TABLE NHAXUATBAN
(
	MANXB NVARCHAR(20) NOT NULL,
	TENNXB NVARCHAR(50),
	DCNXB NVARCHAR(50),
	DTNXB NVARCHAR(50),
)
ALTER TABLE NHAXUATBAN
ADD CONSTRAINT PK_NHAXUATBAN PRIMARY KEY(MANXB)

CREATE TABLE LOAISACH
(
	MALOAISH NVARCHAR(20) NOT NULL,
	TENLOAISH NVARCHAR(50),
)

ALTER TABLE LOAISACH
ADD CONSTRAINT PK_LOAISACH PRIMARY KEY(MALOAISH)

CREATE TABLE SACH
(
	MASH NVARCHAR(20) NOT NULL,
	TENSH NVARCHAR(50),
	TENTG NVARCHAR(50),
	MANXB NVARCHAR(20),
	NAMXB NVARCHAR(20),
	MALOAISH NVARCHAR(20),
	SOLUONG NVARCHAR(20) NOT NULL,
	GIATIEN FLOAT,
)
ALTER TABLE SACH
ADD CONSTRAINT PK_SACH PRIMARY KEY(MASH)
ALTER TABLE SACH
ADD CONSTRAINT FK_SACH_LOAISACH FOREIGN KEY(MALOAISH) REFERENCES LOAISACH(MALOAISH)
ALTER TABLE SACH
ADD CONSTRAINT FK_SACH_NHAXUATBAN FOREIGN KEY(MANXB) REFERENCES NHAXUATBAN(MANXB)


CREATE TABLE KHACHHANG
(
	MAKH NVARCHAR(20) NOT NULL,	
	HOTEN NVARCHAR(50),
	NGAYSINH DATE,
	GIOITINH NVARCHAR(20),
	DIACHI NVARCHAR(50),
	DTKH NVARCHAR(20),

)
ALTER TABLE KHACHHANG
ADD CONSTRAINT PK_KHACHHANG PRIMARY KEY(MAKH)


CREATE TABLE NHANVIEN
(
	MANV NVARCHAR(20) NOT NULL,
	HOTENNV NVARCHAR(50),
	NGAYSINH DATE,
	NGAYVL DATE,
	PHAI NVARCHAR(20),
	DIACHINV NVARCHAR(50),
	LUONG FLOAT,
	CHUCVU NVARCHAR(20),
	MANQL NVARCHAR(20),
	TINHTRANG NVARCHAR(20),
)
ALTER TABLE NHANVIEN
ADD CONSTRAINT PK_NHANVIEN PRIMARY KEY(MANV)

ALTER TABLE NHANVIEN
ADD CONSTRAINT MACDINH_TT DEFAULT N'ĐANG LÀM' FOR TINHTRANG

CREATE TABLE TAIKHOAN
(
	MATK NVARCHAR(20) NOT NULL,
	QUYEN NVARCHAR(20) NOT NULL,
	PASSWORK NVARCHAR(20),
	NGAYLAP DATE,
	
)

ALTER TABLE TAIKHOAN
ADD CONSTRAINT PK_TAIKHOAN PRIMARY KEY(MATK)
ALTER TABLE TAIKHOAN
ADD CONSTRAINT FK_TAIKHOAN_NHANVIEN FOREIGN KEY(MATK) REFERENCES NHANVIEN(MANV)

--RANG BUOC
ALTER TABLE TAIKHOAN
ADD CONSTRAINT DF_TAIKHOAN DEFAULT('123456789') FOR PASSWORK
ALTER TABLE TAIKHOAN
ADD CONSTRAINT DF_TAIKHOAN_1 DEFAULT(CONVERT(DATE,GETDATE(),111)) FOR NGAYLAP

CREATE TABLE HOADONNHAP
(
	MAHDN NVARCHAR(20) NOT NULL,
	MANV NVARCHAR(20) NOT NULL,
	MANXB NVARCHAR(20) NOT NULL,
	TONGTIEN FLOAT,
	NGAYNHAP DATETIME,
);
ALTER TABLE HOADONNHAP
ADD CONSTRAINT DF_NGAYNHAP DEFAULT(CONVERT(DATE,GETDATE(),111)) FOR NGAYNHAP
ALTER TABLE HOADONNHAP
ADD CONSTRAINT DF_TONGTIEN_NHAP DEFAULT(0) FOR TONGTIEN
ALTER TABLE HOADONNHAP
ADD CONSTRAINT PK_MAHDN PRIMARY KEY(MAHDN)
ALTER TABLE HOADONNHAP
ADD CONSTRAINT FK_HOADONNHAP_NHANVIEN FOREIGN KEY(MANV) REFERENCES NHANVIEN(MANV)
ALTER TABLE HOADONNHAP
ADD CONSTRAINT FK_HOADONNHAP_NHAXUATBAN FOREIGN KEY(MANXB) REFERENCES NHAXUATBAN(MANXB)

CREATE TABLE CHITIETHOADONNHAP
(
	MAHDN NVARCHAR(20) NOT NULL,
	MASH NVARCHAR(20) NOT NULL,
	SOLUONG INT,
	DONGIA FLOAT,
);
ALTER TABLE CHITIETHOADONNHAP
ADD CONSTRAINT PK_CHITIETHOADONNHAP PRIMARY KEY(MAHDN,MASH)
ALTER TABLE CHITIETHOADONNHAP
ADD CONSTRAINT FK_CHITIETHOADONNHAP_HOADON FOREIGN KEY(MAHDN) REFERENCES HOADONNHAP(MAHDN)
ALTER TABLE CHITIETHOADONNHAP
ADD CONSTRAINT FK_CHITIETHOADONNHAP_SACH FOREIGN KEY(MASH) REFERENCES SACH(MASH)

CREATE TABLE HOADONXUAT
(
	MAHDX NVARCHAR(20) NOT NULL,
	NGAYLAP DATE,
	MAKH NVARCHAR(20),
	TONGTIEN FLOAT,
	MANV NVARCHAR(20),
	CONSTRAINT PK_HOADONXUAT PRIMARY KEY(MAHDX)
)

ALTER TABLE HOADONXUAT
ADD CONSTRAINT DF_NGAYLAP DEFAULT(CONVERT(DATE,GETDATE(),111)) FOR NGAYLAP
ALTER TABLE HOADONXUAT
ADD CONSTRAINT DF_TONGTIEN_XUAT DEFAULT(0) FOR TONGTIEN
ALTER TABLE HOADONXUAT
ADD CONSTRAINT FK_HOADONXUAT_KHACHHANG FOREIGN KEY(MAKH) REFERENCES KHACHHANG(MAKH)
ALTER TABLE HOADONXUAT
ADD CONSTRAINT FK_HOADONXUAT_NHANVIEN FOREIGN KEY(MANV) REFERENCES NHANVIEN(MANV)

CREATE TABLE CHITIETHDXUAT
(
	MAHDX NVARCHAR(20) NOT NULL,
	MASH NVARCHAR(20) NOT NULL,
	SOLUONG INT,
	DONGIA FLOAT,
)

ALTER TABLE CHITIETHDXUAT
ADD CONSTRAINT PK_CHITIETHDXUAT PRIMARY KEY(MAHDX,MASH)
ALTER TABLE CHITIETHDXUAT
ADD CONSTRAINT FK_CHITIETHDXUAT_HOADONXUAT FOREIGN KEY(MAHDX) REFERENCES HOADONXUAT(MAHDX)
ALTER TABLE CHITIETHDXUAT
ADD CONSTRAINT FK_CHITIETHDXUAT_SACH FOREIGN KEY(MASH) REFERENCES SACH(MASH)



---------------------------------------------------------------------------------------------------------
--------------------------------------*********************************----------------------------------
--------------------------------------NHẬP LIỆU----------------------------------------------------------

INSERT INTO NHAXUATBAN
VALUES ('NXB001',N'Nhà Xuất Bản Thông Tin Và Truyền Thông',N'50 Ngô Quyền,Q.5, TP.HCM','01267589620');
INSERT INTO NHAXUATBAN
VALUES ('NXB002',N'Nhà Xuất Bản Hội Nhà Văn',N'12 Lê Lai,Q.1, TP.HCM','0972356972');
INSERT INTO NHAXUATBAN
VALUES ('NXB003',N'Nhà Xuất Bản Thanh Niên',N'120, Thành Thái,Q.10, TP.HCM','0126874359');
INSERT INTO NHAXUATBAN
VALUES ('NXB004',N'Nhà Xuất Bản Tri Thức',N'474-476 Nguyễn Thị Minh Khai, Q.3, Tp.HCM','0935678549');
INSERT INTO NHAXUATBAN
VALUES ('NXB005',N'Nhà Xuất Bản Trẻ',N'123, Trương Định,Q.3, TP.HCM','0166458928');
INSERT INTO NHAXUATBAN
VALUES ('NXB006',N'Nhà Xuất Bản Lao Động',N'111 Bình Thới, Q.11, TP.HCM','0985123593');
INSERT INTO NHAXUATBAN
VALUES ('NXB007',N'Nhà Xuất Bản Tài Chính',N'111 Bình Thới, Q.11, TP.HCM','07524349278');
INSERT INTO NHAXUATBAN
VALUES ('NXB008',N'Nhà Xuất Bản Lao Động Xã Hội',N'21 Tô Ký, Quận 12, TP.HCM','01287654256');


INSERT INTO LOAISACH
VALUES ('S01',N'Sách Văn Học');
INSERT INTO LOAISACH
VALUES ('S02',N'Sách Kĩ Năng');
INSERT INTO LOAISACH
VALUES ('S03',N'Sách Kinh Tế');
INSERT INTO LOAISACH
VALUES ('S04',N'Sách Tham Khảo ');
INSERT INTO LOAISACH
VALUES ('S05',N'Giáo Trình');
INSERT INTO LOAISACH
VALUES ('S1111',N'Giáo Cụ');


INSERT INTO SACH
VALUES ('0001',N'Lịch Sử Của Tính Hiện Đại','Jacques Attali','NXB001','2012','S01',22,'100.000');
INSERT INTO SACH
VALUES ('0002',N'Tuổi Trẻ Đáng Giá Bao Nhieu ',N'Rosie Nguyễn','NXB002','2016','S02',300,'55.000');
INSERT INTO SACH
VALUES ('0003',N'Nghĩ Đơn Giản, Sống Đơn Thuần ',N'Tolly Burkan','NXB003','2018','S02',60,'60.000');
INSERT INTO SACH
VALUES ('0004',N'Suối Nguồn',N'Ayn Rand','NXB004','2014','S02',108,'108.000');
INSERT INTO SACH
VALUES ('0005',N'Lặng Nghe Cuộc Sống - Lời Nhắn Nhủ Của Mẹ',N'Nguyễn Thu Trang, Nguyễn Hoàng Thu Hà','NXB005','2018','S02',90,'90.000');
INSERT INTO SACH
VALUES ('0006',N'Quản Trị Chiến Lược',N'MBA. Nguyễn Văn Dung ','NXB006','2011','S04',95,'95.000');
INSERT INTO SACH
VALUES ('0007',N'Marketing Công Nghiệp',N'Ths. Hồ Thanh Lan','NXB007','2000','S04',62,'62.500');
INSERT INTO SACH
VALUES ('0008',N'Lịch Sử Của Tính Hiện Đại',N'Vanness Uyên ','NXB008','2017','S05',100,'100.500');
INSERT INTO SACH
VALUES ('0009',N'Thiết Kế Logic Số',N'TS. Đặng Hoài Bắc, TS. Nguyễn Ngọc Minh','NXB001','2015','S05',97,'97.000');
INSERT INTO SACH
VALUES ('0010',N'Thiết Kế Điện Tử Tiên Tiến',N'Th.S Nguyễn Trung Hiếu, TS. Đặng Hoài Bắc','NXB001','2017','S05',69,'69.000');



SET DATEFORMAT DMY
INSERT INTO KHACHHANG
VALUES ('KH001',N'Nguyễn Bảo Ngân','16/03/2012',N'Nữ',N'63/15 Phạm Ngọc Thảo, Tân Phú, TPHCM','01629650425');
INSERT INTO KHACHHANG
VALUES ('KH002',N'Nguyễn Hà Nam','20/03/1998',N'Nam',N'25/15 Tân Lập , Dĩ An,Bình Dương','01603352586');
INSERT INTO KHACHHANG
VALUES ('KH003',N'Bùi Ngọc Khánh Nhi','16/02/1997',N'Nữ',N'1 Tô Vĩnh Kí, Q12, TPHCM','01629650425');
INSERT INTO KHACHHANG
VALUES ('KH004',N'Bùi Thị Mai Trinh','20/10/1995',N'Nữ',N'20 CMT8, Q3, TPHCM','01676007840');
INSERT INTO KHACHHANG
VALUES ('KH005',N'Dương Minh Nghĩa','05/01/1998',N'Nam',N'11 Bình Thới, Q.11, TP.HCM','01629650425');
INSERT INTO KHACHHANG
VALUES ('KH006',N'Nguyễn Quang Vinh','20/05/1998',N'Nam',N'12 Trường Chinh, Tân Bình, TP.HCM','01629652700');
INSERT INTO KHACHHANG
VALUES ('KH007',N'Nguyễn Minh Hiếu','02/01/1998',N'Nam',N'12 Âu Cơ, Tân Bình, TP.HCM','0162960000');


SET DATEFORMAT DMY
INSERT INTO NHANVIEN
VALUES ('NV0001',N'Nguyễn Thị Thùy My','20/03/1998','25/12/2018',N'Nữ',N'13 Hoàng Diệu, thủ Đức, TPHCM','7000000',N'Nhân viên','NQL002',N'ĐANG LÀM');
INSERT INTO NHANVIEN
VALUES ('NV0002',N'Phan Thị Thùy Ly','20/10/1990','2/10/2012',N'Nữ',N'Tân Phú, TPHCM','8000000',N'Nhân viên','NQL003',N'ĐANG LÀM');
INSERT INTO NHANVIEN
VALUES ('NV0003',N'Cao Minh Quốc','05/01/1998','05/01/2017',N'Nam',N' Bình Sơn, Quảng Ngãi','10000000',N'Nhân viên','NQL004',N'ĐANG LÀM');
INSERT INTO NHANVIEN
VALUES ('NV0004',N'Nguyễn Quan Vinh','20/03/1992','05/01/2017',N'Nam',N'Biên Hòa, Đồng Nai','15000000',N'Trưởng Phòng','NQL005',N'ĐANG LÀM');
INSERT INTO NHANVIEN
VALUES ('NV0005',N'Trần THị Thanh Thu','07/02/1998','05/05/2017',N'Nữ',N'Đồng Xoài, Bình Phước','20000000',N'Giám Đốc','NQL006',N'ĐANG LÀM');
INSERT INTO NHANVIEN
VALUES ('NV0006',N'Phùng Thế Hoan','23/03/1991','05/11/2017',N'Nam',N'Bình Tân, TPHCM','9000000',N'Nhân viên','NQL007',N'ĐANG LÀM');
INSERT INTO NHANVIEN
VALUES ('NV0007',N'Nguyễn Thị Thảo Hiền','1/03/1980','28/01/2017',N'Nữ',N'Q2, TPHCM','10000000',N'Nhân viên','NQL008',N'ĐANG LÀM')
INSERT INTO NHANVIEN
VALUES ('NV0008',N'Cao Hải Quan','2/02/1999','05/09/2017',N'Nam',N'Q1, TPHCM','5000000',N'Nhân viên','NQL009',N'ĐANG LÀM')


SET DATEFORMAT DMY
INSERT INTO HOADONXUAT
VALUES ('HD001','12/01/2013','KH001',0,'NV0001');
INSERT INTO HOADONXUAT
VALUES ('HD002','01/11/2015','KH002',0,'NV0002');
INSERT INTO HOADONXUAT
VALUES ('HD003','12/12/2017','KH003','151.000','NV0003');
INSERT INTO HOADONXUAT
VALUES ('HD004','05/1/2018','KH004','160.000','NV0004');

SET DATEFORMAT DMY
INSERT INTO HOADONXUAT
VALUES ('HD005','2/12/2017','KH005','520.000','NV0005');
SET DATEFORMAT DMY
INSERT INTO HOADONXUAT
VALUES ('HD006','20/1/2013','KH006','368.000','NV0006');
INSERT INTO HOADONXUAT
VALUES ('HD007','30/01/2017','KH007','960.000','NV0007');

INSERT INTO CHITIETHDXUAT
VALUES('HD001','0005',2,'100000');
INSERT INTO CHITIETHDXUAT
VALUES('HD002','0002',10,'50000');
INSERT INTO CHITIETHDXUAT
VALUES('HD003','0003','5','520000');
INSERT INTO CHITIETHDXUAT
VALUES('HD004','0004','3','120000');
INSERT INTO CHITIETHDXUAT
VALUES('HD005','0005','4','99000');
INSERT INTO CHITIETHDXUAT
VALUES('HD006','0006','1','110000');
INSERT INTO CHITIETHDXUAT
VALUES('HD007','0007','2','320000');

SET DATEFORMAT DMY
INSERT INTO TAIKHOAN(MATK,QUYEN)
VALUES ('NV0001','admin')
INSERT INTO TAIKHOAN(MATK,QUYEN)
VALUES ('NV0003','user');


-------------------------------------------TRIGGER---------------------------------------------------------
----------------------------------****************************---------------------------------------------
-----------------------------------------------------------------------------------------------------------


--RANG BUOC TONG TIEN HOA DON XUAT TRONG HOA DON KO DC PHEP AM

CREATE TRIGGER RANGBUOC_TONGTIEN_HDXUAT
ON HOADONXUAT
FOR INSERT, UPDATE
AS
	BEGIN
	IF(SELECT TONGTIEN FROM INSERTED)<0
		BEGIN
			PRINT N'TỔNG TIỀN PHẢI LỚN HƠN 0'
			ROLLBACK TRAN
		END
	END
GO
--RANG BUOC TONG TIEN HOA DON NHAP TRONG HOA DON KO DC PHEP AM

CREATE TRIGGER RANGBUOC_TONGTIEN_HDNHAP
ON HOADONNHAP
FOR INSERT, UPDATE
AS
	BEGIN
	IF(SELECT TONGTIEN FROM INSERTED)<0
		BEGIN
			PRINT N'TỔNG TIỀN KHÔNG ĐƯỢC NHỎ HƠN 0'
			ROLLBACK TRAN
		END
	END
GO

--TU THEM DON GIA TRONG CHITIETHD XUAT KHI NHAP MA SACH

CREATE TRIGGER THEMGIAVAOCTHD_XUAT
ON CHITIETHDXUAT
FOR INSERT
AS
	DECLARE @DG MONEY
	SET @DG=(SELECT GIATIEN FROM INSERTED, SACH WHERE INSERTED.MASH=SACH.MASH)
	UPDATE CHITIETHDXUAT
	SET DONGIA=@DG
	WHERE CHITIETHDXUAT.MAHDX=(SELECT MAHDX FROM INSERTED) AND CHITIETHDXUAT.MASH=(SELECT MASH FROM INSERTED)
GO

--GIAM SO LUONG SACH

CREATE TRIGGER GIAMSLSACH
ON CHITIETHDXUAT
FOR INSERT
AS
	BEGIN
		IF(SELECT SACH.SOLUONG FROM SACH, INSERTED WHERE INSERTED.MASH=SACH.MASH)=0
		BEGIN
			PRINT'HET HANG'
			ROLLBACK TRAN
		END
		ELSE
		BEGIN
			IF(SELECT SOLUONG FROM INSERTED)>(SELECT SACH.SOLUONG FROM SACH, INSERTED WHERE INSERTED.MASH=SACH.MASH)
			BEGIN
				PRINT N'KHONG DU HANG BAN'
				ROLLBACK TRAN
			END
			ELSE
			BEGIN
			UPDATE SACH
			SET SOLUONG=SOLUONG-(SELECT SOLUONG FROM INSERTED)
			WHERE SACH.MASH=(SELECT MASH FROM INSERTED)
			END
		END
	END


--TANG SO LUONG SACH


CREATE TRIGGER TANGSLSACH
ON CHITIETHOADONNHAP
FOR INSERT
AS
	BEGIN
		UPDATE SACH
		SET SOLUONG=SOLUONG+(SELECT SOLUONG FROM INSERTED)
		WHERE SACH.MASH=(SELECT MASH FROM INSERTED)
	END
GO


--TINH TONG TIEN HOA DON XUAT


CREATE TRIGGER TT_HD_XUAT
ON CHITIETHDXUAT
FOR INSERT
AS
	BEGIN
		UPDATE HOADONXUAT
		SET TONGTIEN=TONGTIEN+(SELECT SUM(SOLUONG*DONGIA) FROM INSERTED WHERE INSERTED.MAHDX=HOADONXUAT.MAHDX)
		WHERE HOADONXUAT.MAHDX=(SELECT MAHDX FROM INSERTED)
	END
GO


--TINH TONG TIEN HOA DON NHAP


CREATE TRIGGER TT_HD_NHAP
ON CHITIETHOADONNHAP
FOR INSERT, UPDATE,DELETE
AS
	BEGIN
		UPDATE HOADONNHAP
		SET TONGTIEN=TONGTIEN+(SELECT SUM(SOLUONG*DONGIA) FROM INSERTED WHERE INSERTED.MAHDN=HOADONNHAP.MAHDN)
		WHERE HOADONNHAP.MAHDN=(SELECT MAHDN FROM INSERTED)
	END
GO


--TAO NHAN VIEN TU DONG THEM TAI KHOAN ,XOA TAI KHOAN


CREATE TRIGGER NV_TK
ON NHANVIEN
FOR INSERT, DELETE
AS
	BEGIN
		INSERT INTO TAIKHOAN(MATK,QUYEN)
			SELECT MATK=INSERTED.MANV,QUYEN='USER' FROM INSERTED
		DELETE TAIKHOAN
		WHERE MATK=(SELECT MANV FROM DELETED)
	END


--RANG BUOC SO LUONG SACH LON HON 0


CREATE TRIGGER SL_SACH
ON SACH
FOR INSERT,UPDATE
AS
	BEGIN 
	IF(SELECT SOLUONG FROM INSERTED)<0
		BEGIN
		PRINT N'SỐ LƯỢNG SÁCH KHÔNG NHỎ HƠN 0'
		ROLLBACK TRAN
		END
	END


--SO LUONG MUA SACH TRONG CHI TIET HOA DON XUAT LON HON 0


CREATE TRIGGER CTHD_SACH_XUAT
ON CHITIETHDXUAT
FOR INSERT, UPDATE, DELETE
AS
	BEGIN
	IF(SELECT INSERTED.SOLUONG FROM INSERTED)<0
		BEGIN
			PRINT N'SỐ LƯỢNG SÁCH PHẢI LỚN HƠN 0'
			ROLLBACK TRAN
		END
END

--SO LUONG NHAP SACH TRONG CHI TIET HOA DON NHAP LON HON 0


CREATE TRIGGER CTHD_SACH_NHAP
ON CHITIETHOADONNHAP
FOR INSERT, UPDATE, DELETE
AS
	BEGIN
	IF(SELECT INSERTED.SOLUONG FROM INSERTED)<0
		BEGIN
			PRINT N'SỐ LƯỢNG PHẢI LỚN HƠN 0'
			ROLLBACK TRAN
		END
	END


--FUNCTION
--TAO MA HOA DON NHAP TU DONG

CREATE FUNCTION SINHMA_HDN()
RETURNS VARCHAR(30)
AS
	BEGIN
	DECLARE @MHD VARCHAR(100)
	SET @MHD='HDN'+CONVERT(NVARCHAR(10),MONTH(GETDATE()))+CONVERT(NVARCHAR(10),DAY(GETDATE()))+REPLACE(((CONVERT(NVARCHAR(10),(GETDATE()),108))),':','')
	RETURN @MHD
END


--TAO MA HOA DON XUAT TU DONG

CREATE FUNCTION SINHMA_HDX()
RETURNS VARCHAR(30)
AS
	BEGIN
	DECLARE @MHD VARCHAR(100)
	SET @MHD='HDX'+CONVERT(NVARCHAR(10),MONTH(GETDATE()))+CONVERT(NVARCHAR(10),DAY(GETDATE()))+REPLACE(((CONVERT(NVARCHAR(10),(GETDATE()),108))),':','')
	RETURN @MHD
END


--TAO MA KHACH HANG TU DONG


CREATE FUNCTION SINHMA_KH()
RETURNS VARCHAR(30)
AS
	BEGIN
	DECLARE @MKH VARCHAR(100)
	SET @MKH='KH'+CONVERT(NVARCHAR(10),GETDATE(),112)+REPLACE(((CONVERT(NVARCHAR(10),(GETDATE()),108))),':','')
	RETURN @MKH
END 


--IN DS SACH THEO TEN TG


CREATE FUNCTION DSSACH_TG (@TENTG NVARCHAR(50))
RETURNS TABLE
AS
	RETURN (SELECT * FROM SACH WHERE TENTG LIKE '%'+@TENTG+'%')
GO


--INDS SACH THEO TEN SACH


CREATE FUNCTION DSSACH_TENSACH (@TENTS NVARCHAR(50))
RETURNS TABLE
AS
	RETURN (SELECT * FROM SACH WHERE TENSH LIKE '%'+@TENTS+'%')
GO



--IN DS SACH THEO TEN SACH VA TG


CREATE FUNCTION DSSACH_TG_TS (@TENTG NVARCHAR(50), @TENSACH NVARCHAR(50))
RETURNS TABLE
AS
	RETURN (SELECT * FROM SACH WHERE TENTG LIKE '%'+@TENTG+'%' AND TENSH LIKE '%'+@TENSACH+'%')
GO


-- IN DS SACH THEO TEN NXB


CREATE FUNCTION DSSACH_NHAXUATBAN (@TENNXB NVARCHAR(100))
RETURNS TABLE
AS
	RETURN (SELECT SACH.MASH, SACH.TENSH, SACH.TENTG, SACH.MANXB,TENNXB,NHAXUATBAN.DCNXB,NHAXUATBAN.DTNXB, SACH.NAMXB, SACH.MALOAISH, SACH.SOLUONG, SACH.GIATIEN FROM SACH,NHAXUATBAN WHERE TENNXB LIKE '%'+@TENNXB+'%' AND NHAXUATBAN.MANXB=SACH.MANXB)
GO



-- IN DS THEO TEN NXB


CREATE FUNCTION DS_NHAXUATBAN (@TENNXB NVARCHAR(100))
RETURNS TABLE
AS
	RETURN (SELECT * FROM NHAXUATBAN WHERE TENNXB LIKE '%'+@TENNXB+'%' )
GO


--IN THÔNG TIN LOẠI SÁCH THEO TENLOAISH


CREATE FUNCTION XEMTT_LS_TLS(@TLS NVARCHAR(10))
RETURNS TABLE
AS
	RETURN (SELECT * FROM LOAISACH WHERE LOAISACH.TENLOAISH LIKE '%'+@TLS+'%')
GO


--IN THÔNG TIN LOẠI SÁCH THEO MALOAISH


CREATE FUNCTION XEMTT_LS(@MLS NVARCHAR(10))
RETURNS TABLE
AS
	RETURN (SELECT * FROM LOAISACH WHERE LOAISACH.MALOAISH LIKE '%'+@MLS+'%')
GO


--TÌM NHÂN VIÊN DỰA VÀO TÊN NHÂN VIÊN


CREATE FUNCTION XEM_TENKH(@TENKH NVARCHAR(50))
	RETURNS TABLE
	AS
	RETURN(SELECT * FROM KHACHHANG WHERE HOTEN LIKE '%'+@TENKH+'%')


--XUAT THONG TIN NHAN VIEN THEO TENNV


CREATE FUNCTION XEMTT_NV_TNV(@TNV NVARCHAR(50))
RETURNS TABLE
AS
	RETURN (SELECT * FROM NHANVIEN WHERE HOTENNV LIKE '%'+@TNV+'%')
GO


--XUAT THONG TIN NHAN VIEN THEO MANV


CREATE FUNCTION XEMTT_NV(@MNV NVARCHAR(10))
RETURNS TABLE
AS
	RETURN (SELECT * FROM NHANVIEN WHERE NHANVIEN.MANV LIKE '%'+@MNV+'%')
GO


--XUAT TEN NHAN VIEN THEO MANV


CREATE FUNCTION XEM_TENNV(@MNV NVARCHAR(10))
RETURNS NVARCHAR(50)
AS
	BEGIN
		DECLARE @HT NVARCHAR(50)
		SET @HT=(SELECT HOTENNV FROM NHANVIEN WHERE MANV LIKE '%'+@MNV+'%')
		RETURN @HT
END


--SACH BAN DC NHIEU NHAT


CREATE FUNCTION XEM_SACHDCNHIEUNHAT()
RETURNS TABLE
AS
	RETURN (SELECT SACH.MASH, SACH.TENSH, SACH.TENTG,SUM(CHITIETHDXUAT.SOLUONG) AS 'TONG' FROM CHITIETHDXUAT,SACH WHERE SACH.MASH=CHITIETHDXUAT.MASH 
				GROUP BY SACH.MASH, SACH.TENSH, SACH.TENTG
				HAVING SUM(CHITIETHDXUAT.SOLUONG)>= ALL(SELECT SUM(SOLUONG) FROM CHITIETHDXUAT GROUP BY CHITIETHDXUAT.MASH) )
GO


--SACH NHAP NHIEU NHAT


CREATE FUNCTION XEM_SACHNHAPNHIEUNHAT()
RETURNS TABLE
AS
	RETURN (SELECT SACH.MASH, SACH.TENSH, SACH.TENTG,SUM(CHITIETHOADONNHAP.SOLUONG) AS 'TONG' FROM CHITIETHOADONNHAP,SACH WHERE SACH.MASH=CHITIETHOADONNHAP.MASH 
				GROUP BY SACH.MASH, SACH.TENSH, SACH.TENTG
				HAVING SUM(CHITIETHOADONNHAP.SOLUONG)>= ALL(SELECT SUM(SOLUONG) FROM CHITIETHOADONNHAP GROUP BY CHITIETHOADONNHAP.MASH) )
GO

--XEM SO SACH DA BAN THEO MA HOA DON XUAT


CREATE FUNCTION XEM_SACH_HD(@MHDX NVARCHAR(10))
RETURNS TABLE
AS
	RETURN (SELECT SACH.MASH, SACH.TENTG, CHITIETHDXUAT.DONGIA, SUM(CHITIETHDXUAT.SOLUONG) AS TONG_SL_SACH, HOADONXUAT.NGAYLAP  FROM CHITIETHDXUAT,SACH,HOADONXUAT WHERE SACH.MASH=CHITIETHDXUAT.MASH AND CHITIETHDXUAT.MAHDX=HOADONXUAT.MAHDX AND CHITIETHDXUAT.MAHDX LIKE '%'+@MHDX+'%'
			GROUP BY SACH.MASH, SACH.TENTG, CHITIETHDXUAT.DONGIA,HOADONXUAT.NGAYLAP)
GO



--XEM SO SACH DA NHAP THEO MA HOA DON NHAP


CREATE FUNCTION XEM_SACH_HDN(@MHDN NVARCHAR(10))
RETURNS TABLE
AS
	RETURN (SELECT SACH.MASH, SACH.TENTG, CHITIETHOADONNHAP.DONGIA, SUM(CHITIETHOADONNHAP.SOLUONG) AS TONG_SL_SACH, HOADONNHAP.NGAYNHAP  FROM CHITIETHOADONNHAP,SACH,HOADONNHAP WHERE SACH.MASH=CHITIETHOADONNHAP.MASH AND CHITIETHOADONNHAP.MAHDN=HOADONNHAP.MAHDN AND CHITIETHOADONNHAP.MAHDN LIKE '%'+@MHDN+'%'
			GROUP BY SACH.MASH, SACH.TENTG, CHITIETHOADONNHAP.DONGIA, HOADONNHAP.NGAYNHAP)
GO



--XEM SACH TON TRONG KHO THEO MA SACH


CREATE FUNCTION XEM_SACH_TRONGKHO_THEOMA(@MS NVARCHAR(20))
RETURNS TABLE
AS
	RETURN (SELECT MASH, TENSH, TENTG, SOLUONG, NHAXUATBAN.TENNXB, NHAXUATBAN.DCNXB, NHAXUATBAN.DTNXB FROM SACH, NHAXUATBAN WHERE SACH.MANXB=NHAXUATBAN.MANXB AND SACH.MASH LIKE '%'+@MS+'%')
GO


--TRUY XUAT KHACH HANG THEO THONG TIN TRUYEN VAO


CREATE FUNCTION INTHONGTINKH(@MKH NVARCHAR(20),@TENKH NVARCHAR(50),@SDT NVARCHAR(20),@DC NVARCHAR(50), @GT NVARCHAR(6))
RETURNS TABLE
AS
	RETURN (SELECT * FROM KHACHHANG WHERE KHACHHANG.MAKH LIKE '%'+@MKH+'%' AND KHACHHANG.HOTEN LIKE '%'+@TENKH+'%' AND KHACHHANG.DTKH LIKE '%'+@SDT+'%' AND KHACHHANG.DIACHI LIKE '%'+@DC+'%' AND KHACHHANG.GIOITINH LIKE '%'+@GT+'%')
GO


-- IN CAC SACH BAN THEO NGAY


CREATE FUNCTION XEM_SACH_HDX_NL(@NGAYLAP DATE)
RETURNS TABLE
AS
	RETURN (SELECT SACH.MASH, SACH.TENTG, CHITIETHDXUAT.DONGIA, SUM(CHITIETHDXUAT.SOLUONG) AS TONG  FROM CHITIETHDXUAT,SACH,HOADONXUAT WHERE SACH.MASH=CHITIETHDXUAT.MASH AND CHITIETHDXUAT.MAHDX=HOADONXUAT.MAHDX
			AND HOADONXUAT.NGAYLAP=@NGAYLAP GROUP BY SACH.MASH, SACH.TENTG, CHITIETHDXUAT.DONGIA)
GO


-- IN CAC SACH NHAP THEO NGAY


CREATE FUNCTION XEM_SACH_HDN_NN(@NGAYNHAP DATE)
RETURNS TABLE
AS
	RETURN (SELECT SACH.MASH, SACH.TENTG, CHITIETHOADONNHAP.DONGIA, SUM(CHITIETHOADONNHAP.SOLUONG) AS TONG  FROM CHITIETHOADONNHAP,SACH,HOADONNHAP WHERE SACH.MASH=CHITIETHOADONNHAP.MASH AND CHITIETHOADONNHAP.MAHDN=HOADONNHAP.MAHDN
			AND HOADONNHAP.NGAYNHAP=@NGAYNHAP GROUP BY SACH.MASH, SACH.TENTG, CHITIETHOADONNHAP.DONGIA)
GO


--SO SACH DA BAN THEO NGAY


CREATE FUNCTION XEM_SACH_SLSACHBAN_THEONGAYBAN(@NGAYLAP DATE)
RETURNS TABLE
AS
	RETURN (SELECT SACH.MASH, SACH.TENTG, CHITIETHDXUAT.DONGIA, SUM(CHITIETHDXUAT.SOLUONG) AS TONG FROM CHITIETHDXUAT,SACH,HOADONXUAT WHERE SACH.MASH=CHITIETHDXUAT.MASH AND CHITIETHDXUAT.MAHDX=HOADONXUAT.MAHDX AND HOADONXUAT.NGAYLAP=@NGAYLAP GROUP BY SACH.MASH, SACH.TENTG, CHITIETHDXUAT.DONGIA)
GO



--TIM KIEM THEO DU LIEU TRUYEN VAO CUA TAI KHOAN


CREATE FUNCTION XEMTK_QUYEN(@MTK NVARCHAR(10),@Q NVARCHAR(10))
RETURNS TABLE
AS
	RETURN (SELECT * FROM TAIKHOAN WHERE TAIKHOAN.QUYEN LIKE '%'+@Q+'%' AND TAIKHOAN.MATK LIKE '%'+@MTK+'%')




-----------------------------------------------PROCEDUCE----------------------------------------------------
------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------

--THEM NHANVIEN

CREATE PROC THEMNV @MANV NVARCHAR(30),@TENNV NVARCHAR(50),@GIOITINH NVARCHAR(10),@DIACHI NVARCHAR(50),@NGAYSINH DATE,@NGAYVAOLAM DATE,@CHUCVU NVARCHAR(50),@LUONG FLOAT,@MAQL NVARCHAR(30),@KIEMTRA INT OUTPUT
AS
BEGIN
	IF NOT EXISTS(SELECT * FROM NHANVIEN WHERE @MANV=NHANVIEN.MANV)
	BEGIN
		INSERT INTO NHANVIEN VALUES(@MANV,@TENNV,@NGAYSINH,@NGAYVAOLAM,@GIOITINH,@DIACHI,@LUONG,@CHUCVU,@MAQL,N'ĐANG LÀM')
		SET @KIEMTRA=1
	END
	ELSE
		SET @KIEMTRA=0
END



--XOA NHANVIEN


CREATE PROC XOANV @MANV NVARCHAR(30),@KIEMTRA INT OUTPUT
AS
BEGIN
	IF EXISTS(SELECT * FROM NHANVIEN WHERE @MANV=NHANVIEN.MANV)
	BEGIN
		UPDATE NHANVIEN	
		SET TINHTRANG=N'NGHỈ'
		WHERE @MANV=NHANVIEN.MANV
		SET @KIEMTRA=1
	END
	ELSE
		SET @KIEMTRA= 0
END


--XÓA TÀI KHOẢN

CREATE PROC XOATK @MATK NVARCHAR(30), @TT NVARCHAR(30), @KIEMTRA INT OUTPUT
AS
BEGIN
	IF EXISTS(SELECT * FROM TAIKHOAN WHERE @MATK=TAIKHOAN.MATK )
	BEGIN
		DELETE TAIKHOAN
		WHERE MATK=@MATK
		SET @KIEMTRA=1
	END
	ELSE
		SET @KIEMTRA= 0
END


--SUA NHANVIEN
--CHỈNH SỬ THÔNG TIN NHÂN VIÊN HOẶC PHỤC HỒI TÌNH TRẠNG NHÂN VIÊN ĐANG LÀM

CREATE PROC SUANV @MANV NVARCHAR(30),@TENNV NVARCHAR(50),@GIOITINH NVARCHAR(10),@DIACHI NVARCHAR(50),@NGAYSINH DATE,@NGAYVAOLAM DATE,@CHUCVU NVARCHAR(50),@LUONG FLOAT,@MAQL NVARCHAR(30),@KIEMTRA INT OUTPUT
AS
BEGIN
	IF EXISTS(SELECT * FROM NHANVIEN WHERE @MANV=NHANVIEN.MANV)
	BEGIN
		SET DATEFORMAT DMY
		UPDATE NHANVIEN	
		SET HOTENNV=@TENNV,NGAYSINH=@NGAYSINH, NGAYVL=@NGAYVAOLAM, PHAI=@GIOITINH, DIACHINV=@DIACHI, LUONG=@LUONG, CHUCVU=@CHUCVU, MANQL=@MAQL, TINHTRANG=N'ĐANG LÀM'
		WHERE @MANV=NHANVIEN.MANV
		SET @KIEMTRA=1
	END
	ELSE
		SET @KIEMTRA= 0
END




--QUY DINH SO NGAY DUOC DOI TRA


CREATE PROC IN_SONGAYDAMUA @MHDX NVARCHAR(10), @THOIHAN INT OUTPUT
AS
	BEGIN
		IF NOT EXISTS(SELECT * FROM CHITIETHDXUAT,HOADONXUAT WHERE CHITIETHDXUAT.MAHDX=@MHDX AND CHITIETHDXUAT.MAHDX=HOADONXUAT.MAHDX)
			RETURN 0;
		SELECT @THOIHAN= DATEDIFF(DAY,NGAYLAP,CONVERT(DATE,GETDATE(),111)) FROM HOADONXUAT WHERE MAHDX=@MHDX
		IF(@THOIHAN)>3
			RETURN 1
		ELSE
			RETURN 2
END
DECLARE @TT INT
DECLARE @KQ TINYINT
EXEC @KQ=IN_SONGAYDAMUA 'HD001', @TT OUTPUT
IF @KQ=0
	PRINT N'MA KO TON TAI'
ELSE
	IF @KQ=2
	PRINT N'THOI GIAN CHO PHEP DOI TRA CON :'+CAST(@TT AS NVARCHAR(20))+'NGAY'
	ELSE
		IF @KQ=1
		PRINT N'HET HAN BAO HANH'


---CẤP MÃ CHO NHÂN VIÊN TỰ ĐỘNG DỰA VÀO NGÀY VÀ NĂM VÀO LÀM

CREATE PROC TAOMANV @MANV NVARCHAR(30) OUTPUT
AS
	BEGIN
		DECLARE @THUTU INT
		SELECT @THUTU = COUNT(*)
		FROM NHANVIEN
		WHERE MANV LIKE '%'+CONVERT(VARCHAR,YEAR(GETDATE()))+SUBSTRING(CONVERT(VARCHAR,GETDATE(),104),4,2)+'%'
		SET @MANV = 'NV'+CONVERT(VARCHAR,YEAR(GETDATE()))+SUBSTRING(CONVERT(VARCHAR,GETDATE(),104),4,2)+CONVERT(VARCHAR,(@THUTU))
	END




-----------------------------------
---------------------------------TẠO QUYỀN Ở SQL---------------------------------
---------------------------************************------------------------------
----------------------------------QUYỀN ADMIN------------------------------------
		--------------TẠO LOGIN
		SP_ADDLOGIN 'ADMIN','123','QLNHASACH'
		---------------TẠO USER
		USE QLNHASACH
		GO
		SP_ADDUSER 'ADMIN','ADMIN'

		---------------ADD ADMIN VÀO NHÓM SETUPADMIN
		SP_ADDSRVROLEMEMBER 'ADMIN','SETUPADMIN'

		---------------ADD ADMIN VÀO NHÓM QUYỀN DB_OWNER

		SP_ADDROLEMEMBER 'DB_OWNER','ADMIN'



---------------------------************************------------------------------
----------------------------------QUYỀN KHÁCH HÀNG------------------------------------

--------------TẠO LOGIN
		SP_ADDLOGIN 'KHACHHANG','123','QLNHASACH'
		---------------TẠO USER
		USE QLNHASACH
		GO
		SP_ADDUSER 'KHACHHANG','KHACHHANG'

		---------------ADD ADMIN VÀO NHÓM SETUPADMIN
		SP_ADDSRVROLEMEMBER 'KHACHHANG','SETUPADMIN'

		---------------ADD ADMIN VÀO NHÓM QUYỀN DB_DATAREADER

		SP_ADDROLEMEMBER 'DB_DATAREADER','KHACHHANG'



---------------------------------------------SAO LƯU PHỤC HỒI DỮ LIỆU----------------------------------
---------------------------------------------************************---------------------------------------

--BACKUP DU LIEU
--BACKUP FULL
BACKUP DATABASE QLNHASACH
TO DISK='C:\baocao\QLSV_BC-FULL.BAK'
--BACKUP DIFFERENTIAL
BACKUP DATABASE QLNHASACH
TO DISK='C:\baocao\QLSV_BC-DIFF.BAK' WITH DIFFERENTIAL
--BACKUP LOG
ALTER DATABASE QLNHASACH
SET RECOVERY FULL

BACKUP LOG QLNHASACH
TO DISK='C:\baocao\QLSV_BC-LOG.TRN' WITH NO_TRUNCATE

--KHÔI PHỤC DATABASE
USE MASTER
RESTORE DATABASE QLNHASACH
FROM DISK='C:\baocao\QLSV_BC-FULL.BAK'
WITH NORECOVERY

USE MASTER
RESTORE DATABASE QLNHASACH
FROM DISK='C:\baocao\QLSV_BC-DIFF.BAK'
WITH RECOVERY

USE MASTER
RESTORE LOG QLNHASACH
FROM DISK='C:\baocao\QLSV_BC-LOG.TRN'
WITH RECOVERY
--THỜI GIAN T3
USE MASTER
RESTORE DATABASE QLNHASACH
FROM DISK='C:\baocao\QLSV_BC-DIFF.BAK'
WITH FILE=3,RECOVERY


